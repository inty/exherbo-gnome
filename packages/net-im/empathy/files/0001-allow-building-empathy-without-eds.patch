From cf4ca3ebb5dd0f28e034ed3bf315ce8edf09d266 Mon Sep 17 00:00:00 2001
From: Saleem Abdulrasool <compnerd@compnerd.org>
Date: Wed, 3 Mar 2010 20:30:24 +0000
Subject: [PATCH] allow building empathy without eds

---
 configure.ac                            |   15 +++++++++++++--
 src/Makefile.am                         |    2 ++
 src/empathy-auto-salut-account-helper.c |    7 +++++++
 3 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/configure.ac b/configure.ac
index 6f9474d..b3a407e 100644
--- a/configure.ac
+++ b/configure.ac
@@ -198,7 +198,6 @@ PKG_CHECK_MODULES(EMPATHY,
    gio-2.0 >= $GLIB_REQUIRED
    gdk-x11-2.0
    gtk+-2.0 >= $GTK_REQUIRED
-   libebook-1.2
    dbus-glib-1
    telepathy-glib >= $TELEPATHY_GLIB_REQUIRED
    telepathy-farsight
@@ -206,6 +205,7 @@ PKG_CHECK_MODULES(EMPATHY,
    gstreamer-0.10
    unique-1.0
    gnome-keyring-1 >= $KEYRING_REQUIRED
+   gconf-2.0
 ])
 
 PKG_CHECK_MODULES(LIBEMPATHY_ACCOUNTS_PANEL,
@@ -215,7 +215,6 @@ PKG_CHECK_MODULES(LIBEMPATHY_ACCOUNTS_PANEL,
    gio-2.0 >= $GLIB_REQUIRED
    gdk-x11-2.0
    gtk+-2.0 >= $GTK_REQUIRED
-   libebook-1.2
    dbus-glib-1
    telepathy-glib >= $TELEPATHY_GLIB_REQUIRED
    unique-1.0
@@ -246,6 +245,18 @@ AC_DEFINE_UNQUOTED(GETTEXT_PACKAGE,"$GETTEXT_PACKAGE",[Gettext package name])
 
 AM_GLIB_GNU_GETTEXT
 
+AC_ARG_WITH(eds,
+            AC_HELP_STRING([--with-eds], [build with eds support]),,
+	    [with_eds=yes])
+
+if test x"$with_eds" = x"yes" ; then
+  PKG_CHECK_MODULES(EDS, libebook-1.2)
+  AC_SUBST(EDS_CFLAGS)
+  AC_SUBST(EDS_LIBS)
+  AC_DEFINE(HAVE_EDS, 1, [Define if you have libebook])
+fi
+AM_CONDITIONAL(WITH_EDS, [test x"$with_eds" = x"yes"])
+
 # -----------------------------------------------------------
 # Connectivity integration
 # -----------------------------------------------------------
diff --git a/src/Makefile.am b/src/Makefile.am
index 3f8d157..09e5cd7 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -2,6 +2,7 @@ include $(top_srcdir)/tools/flymake.mk
 
 CPPFLAGS_COMMON =					\
 	$(EMPATHY_CFLAGS)				\
+	$(EDS_CFLAGS)                                   \
 	$(ERROR_CFLAGS)					\
 	-I$(top_srcdir)                          	\
 	-DG_LOG_DOMAIN=\"empathy\"			\
@@ -26,6 +27,7 @@ LDADD =								\
 	$(TPL_LIBS)						\
 	$(LIBNOTIFY_LIBS)					\
 	$(EMPATHY_LIBS)						\
+	$(EDS_LIBS)                                             \
 	$(LIBCHAMPLAIN_LIBS)					\
 	$(WEBKIT_LIBS)
 
diff --git a/src/empathy-auto-salut-account-helper.c b/src/empathy-auto-salut-account-helper.c
index ad4d6cb..c34124b 100644
--- a/src/empathy-auto-salut-account-helper.c
+++ b/src/empathy-auto-salut-account-helper.c
@@ -24,7 +24,10 @@
 
 #include <telepathy-glib/account-manager.h>
 #include <telepathy-glib/util.h>
+
+#if HAVE_EDS
 #include <libebook/e-book.h>
+#endif
 
 #include <libempathy/empathy-account-settings.h>
 #include <libempathy-gtk/empathy-conf.h>
@@ -83,6 +86,7 @@ EmpathyAccountSettings *
 create_salut_account_settings (void)
 {
   EmpathyAccountSettings  *settings;
+#if HAVE_EDS
   EBook *book;
   EContact *contact;
   gchar *nickname = NULL;
@@ -91,10 +95,12 @@ create_salut_account_settings (void)
   gchar *email = NULL;
   gchar *jid = NULL;
   GError *error = NULL;
+#endif
 
   settings = empathy_account_settings_new ("salut", "local-xmpp",
       _("People nearby"));
 
+#if HAVE_EDS
   /* Get self EContact from EDS */
   if (!e_book_get_self (&contact, &book, &error))
     {
@@ -135,6 +141,7 @@ create_salut_account_settings (void)
   g_free (jid);
   g_object_unref (contact);
   g_object_unref (book);
+#endif
 
   return settings;
 }
-- 
1.7.0.1

